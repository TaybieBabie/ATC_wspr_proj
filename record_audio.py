# record_audio.py
import pyaudio
import wave
import datetime
import os
import threading
import queue
import numpy as np
import requests
import subprocess
import time

from console_logger import info, success, warning, error
from config import SAMPLE_RATE, CHANNELS, AUDIO_DIR


class LiveATCRecorder:
    def __init__(self, stream_url, vad_threshold=0.01, silence_duration=2.0):
        self.stream_url = stream_url
        self.vad_threshold = vad_threshold
        self.silence_duration = silence_duration
        self.is_recording = False
        self.ffmpeg_process = None
        self.sample_rate = SAMPLE_RATE
        self.channels = CHANNELS

        if not os.path.exists(AUDIO_DIR):
            os.makedirs(AUDIO_DIR)

    def capture_stream_audio(self):
        """Capture audio from LiveATC stream using ffmpeg"""
        cmd = [
            'ffmpeg',
            '-i', self.stream_url,
            '-f', 's16le',
            '-acodec', 'pcm_s16le',
            '-ar', str(self.sample_rate),
            '-ac', str(self.channels),
            '-'
        ]
        try:
            self.ffmpeg_process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.DEVNULL
            )
            return self.ffmpeg_process.stdout
        except FileNotFoundError:
            error("ffmpeg not found. Please ensure ffmpeg is installed and in your system's PATH.")
            return None
        except Exception as e:
            error(f"Error starting stream capture: {e}")
            return None

    def detect_voice_activity(self, audio_data):
        """Simple VAD based on RMS energy"""
        if not audio_data:
            return False

        audio_array = np.frombuffer(audio_data, dtype=np.int16)
        if audio_array.size == 0:
            return False

        rms = np.sqrt(np.mean(audio_array.astype(np.float64) ** 2))
        normalized_rms = rms / 32768.0
        return normalized_rms > self.vad_threshold

    def save_audio_segment(self, audio_data, frequency=None):
        """Save recorded audio segment to file"""
        if not audio_data:
            return None

        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S_%f")[:-3]
        freq_str = f"_{frequency.replace('.', 'p')}" if frequency else ""
        filename = os.path.join(AUDIO_DIR, f"transmission_{timestamp}{freq_str}.wav")

        try:
            with wave.open(filename, 'wb') as wf:
                wf.setnchannels(self.channels)
                wf.setsampwidth(2)
                wf.setframerate(self.sample_rate)
                wf.writeframes(b''.join(audio_data))
            success(f"Saved transmission: {os.path.basename(filename)}", emoji="ÔøΩ")
            return filename
        except Exception as e:
            error(f"Error saving audio to {filename}: {e}")
            return None

    def record_with_vad(self, frequency=None, max_duration=None):
        """Record audio with voice activity detection."""
        info(f"Starting stream capture from: {self.stream_url}")

        print(r"""
        ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£§‚£§‚£§‚£¥‚£¶‚£∂‚£§‚£§‚£Ä‚£Ä‚£§‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚£æ‚†ø‚†ø‚£∂‚£¶‚£Ñ‚°Ä‚†Ä‚¢Ä‚£†‚£¥‚£∂‚†ø‚†ø‚†õ‚†ã‚†â‚†â‚†â‚†â‚†Ä‚†Ä‚†à‚†â‚†õ‚†ã‚†â‚†â‚†ô‚†ª‚£∑‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£ø‚†è‚†Ä‚£†‚£Ñ‚°Ä‚†à‚†ô‚£ø‚°æ‚†ü‚†ã‚†Å‚¢Ä‚£Ä‚°§‚†∂‚†ñ‚†õ‚†õ‚†≤‚†û‚†ã‚†â‚†õ‚†õ‚†í‚†≤‚¢ø‚£∑‚£¶‚£Ñ‚†Ä‚†â‚†ª‚£∑‚£∂‚£§‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£§‚£¥‚£∂‚°∂‚†æ‚†æ‚†ø‚†É‚¢Ä‚£º‚£ø‚£ª‚£ø‚°è‚†Ä‚†â‚£Ä‚£§‚†∂‚†û‚†â‚¢Å‚††‚†Ä‚†Ñ‚°í‚†Ä‚†Ñ‚†Ç‚†å‚¢Ä‚†°‚†ê‚†Ä‚†Ä‚†Ä‚†à‚†ô‚¢ø‚£ø‚£¶‚£Ä‚†Ä‚†Ä‚†à‚†ô‚†ª‚£∑‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£º‚°ø‚†ü‚†É‚†Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†Ä‚£º‚°ø‚£ß‚£ø‚£ø‚†á‚¢Ä‚°º‚†õ‚†Ä‚†Ä‚°Ä‚†ò‚¢Ä‚†Ä‚†Ñ‚¢†‚†É‚††‚¢Ä‚†ò‚†Ä‚†Ñ‚†Ä‚†Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚¢ø‚£ø‚£ß‚°Ä‚†õ‚¢ß‚°Ä‚†ò‚¢ø‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚°ø‚†ã‚†Ä‚°†‚†û‚†ã‚†Ä‚†Ä‚†Ä‚¢Ä‚£æ‚£ø‚£Ω‚£ø‚£ø‚°ø‚£ø‚†ã‚†Ä‚†Ñ‚†Ç‚¢Å‚††‚†à‚°Ä‚†Ñ‚¢à‚°è‚¢Ä‚†ê‚††‚†Ä‚°Å‚†Ç‚¢Å‚††‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†Ä‚°Ä‚†à‚†π‚£ü‚£ø‚£¶‚†Ä‚¢ª‚°Ñ‚†à‚¢ø‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚°ü‚†Ä‚£†‚†û‚†Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ø‚£≥‚£ø‚°ø‚¢É‚°æ‚†Å‚†Ä‚†Ä‚†Ç‚¢à‚†Ä‚¢Ñ‚†û‚†Ä‚°ê‚£ò‚†Ä‚†Ñ‚†Ç‚††‚†Å‚°Ä‚†å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†ê‚°Ä‚†ô‚£ø‚£ø‚†Ä‚°Ä‚¢ø‚†Ä‚†à‚£ø‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚°ü‚†Ä‚¢∞‚¢è‚£æ‚£ø‚£∂‚£é‚£†‚£§‚£º‚£ø‚£ø‚£ø‚°ø‚†Å‚£º‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚°û‚†Ä‚°ê‚†Ä‚£∑‚†Ä‚†Ä‚¢à‚†Ä‚†ê‚†Ä‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ç‚††‚†Ä‚†∏‚°ü‚¢Ä‚†ê‚£∏‚°á‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚†É‚¢Ä‚£ø‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚£ø‚¢É‚¢∞‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°º‚†Ä‚†Ä‚†Ñ‚†Ç‚£Ω‚£Ñ‚†Ä‚†Ä‚†Ä‚¢Ä‚†Ä‚†ô‚†ß‚£Ñ‚†Ä‚††‚†Ä‚†Ñ‚¢Ä‚††‚†ê‚†Ä‚°Ä‚¢ß‚°ê‚†Ä‚¢Ç‚†∞‚¢∏‚°á‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚£Ñ‚£Ä‚£º‚°ü‚†Ä‚£∏‚£ü‚£ø‚£Ω‚£ø‚£ü‚†ª‚¢ø‚£ø‚£º‚£ø‚£ø‚£ø‚¢ä‚£º‚¢°‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∏‚†á‚†Ä‚†Ä‚†ê‚¢Ä‚°á‚†∏‚£¶‚°Ä‚¢à‚†Ä‚†Ä‚†Ä‚£á‚†à‚†õ‚£¶‚£ê‚†à‚†Ä‚†Ñ‚†Ç‚°ê‚†Ä‚°Ä‚¢ß‚†ê‚°Ä‚¢é‚£π‚†á‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚†ø‚°∑‚°ü‚†ø‚¢ã‚†ø‚¢ø‚°ø‚†õ‚†Ä‚¢Ä‚£º‚†ü‚¢∏‚£ø‚£ø‚¢•‚°ü‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚†è‚†Ä‚°Ä‚†Ñ‚†Ä‚£∏‚†Å‚†Ä‚°º‚£ø‚£¶‚°Ä‚†°‚†Ä‚†π‚°Ñ‚†Ä‚†Ä‚†Ω‚¢∑‚£å‚†Ä‚†Ç‚†Ñ‚†Ç‚°Ä‚†ò‚°Ñ‚†∏‚£Ñ‚¢ª‚†Ä‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß‚£õ‚†¥‚£©‚†ù‚°ä‚†Ö‚†Ä‚†Ä‚†Ä‚£†‚£ø‚†ü‚†Ä‚£º‚£ø‚£ø‚°é‚£Ω‚£ø‚†Ä‚†Ä‚††‚£±‚†è‚†Ä‚¢Ç‚¢†‚†Ä‚¢†‚£ø‚£Ä‚°Ä‚†Ä‚†ú‚£ø‚£∑‚£¶‚°ê‚†Ä‚¢ª‚°Ñ‚†Ä‚†Ä‚£π‚£ø‚£∑‚£Ö‚†ê‚††‚¢Ä‚†Å‚°∏‚¢ê‚†¨‚£ª‚†Ä‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚£∂‚°ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß‚†ó‚°å‚†Ä‚†Ä‚†Ä‚£†‚£æ‚£ø‚†ã‚†Ä‚¢∏‚°á‚†Ä‚¢∏‚£∑‚£æ‚£ø‚†á‚†Ä‚¢°‚°ü‚†Ä‚†å‚†Ä‚°é‚†Ä‚£º‚†ã‚†à‚†â‚†ì‚†≤‚¢ø‚£ø‚£ø‚£ø‚£Ñ‚†à‚£ß‚†Ä‚†ö‚†Å‚†∫‚£π‚¢ø‚£∑‚°Ü‚°Ñ‚¢Ç‚°ò‚°á‚¢é‚£Ω‚†Ä‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£†‚£∂‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£≠‚£õ‚¢©‚†Å‚†Ä‚†Ä‚†Ä‚£†‚£æ‚£ø‚°ü‚†Å‚†Ä‚£∞‚£æ‚°á‚†Ä‚†à‚£ø‚£ø‚£ø‚†Å‚¢®‚°ø‚†Å‚†ê‚††‚¢Å‚°á‚¢ê‚£ø‚†Ä‚†Ä‚£Ñ‚†Ä‚†Ä‚†à‚¢ª‚£ø‚£ø‚£ø‚£á‚¢æ‚°á‚†Ä‚†Ä‚£Ä‚£º‚£ø‚£ø‚£ø‚£∑‚¢Ü‚°ú‚£π‚¢Ç‚£ø‚°Ñ‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚¢Ä‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚¢ø‚£ø‚£∑‚£Ñ‚†Ä‚¢Ä‚£¥‚£ø‚°ø‚†ã‚†Ä‚£∞‚£¥‚£ø‚£ø‚£ª‚°∂‚¢§‚£º‚£ø‚°ø‚¢Ä‚£ø‚†É‚¢Ä‚†Å‚†Ç‚¢∏‚£ß‚¢®‚£ø‚£ø‚£∂‚£¶‚£Ñ‚†Ä‚†Ä‚†Ä‚†ª‚£ø‚£ø‚£ø‚£ø‚°á‚¢†‚£æ‚£ø‚£ø‚°Ω‚¢ø‚£ø‚£ø‚£ø‚°ú‚£≥‚†ê‚£æ‚°á‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢Ä‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚£õ‚†ª‚¢ø‚£∑‚£ù‚¢ø‚£ø‚£ß‚£æ‚£ø‚†ü‚†Å‚†Ä‚†Ä‚£ø‚£ø‚£ø‚£ã‚£º‚£∑‚°õ‚°ü‚†ø‚£ø‚£º‚£ü‚†Ä‚†§‚†à‚¢Ä‚£ø‚£ø‚£∏‚£ø‚£ø‚°ü‚£ª‚†ù‚¢ß‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ø‚£ø‚¢∑‚£ø‚£ø‚£ø‚£º‚°á‚†à‚£ø‚£ø‚£ø‚£û‚†±‚†à‚£æ‚°á‚†Ä‚¢ª‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£§‚†ô‚£ø‚£ß‚¢ø‚£ø‚£ø‚†É‚†Ä‚°Ä‚†Ä‚†Ä‚£ø‚°ü‚£ø‚£ß‚£ø‚£ø‚£ø‚£º‚¢≤‚°å‚°Ω‚£ø‚£§‚†Ä‚¢Ç‚¢∞‚£ø‚£ø‚£ø‚†ø‚°ø‚†õ‚£ø‚†Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†π‚†é‚¢Ø‚£ô‚†â‚£∏‚†É‚†∏‚¢´‚£ø‚£ø‚£Ø‚†Ü‚†Å‚¢æ‚°á‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢∏‚£ø‚£ø‚£ø‚£ø‚°è‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£á‚†∏‚£ø‚£æ‚£ø‚°á‚†Ä‚††‚†Ü‚£†‚£º‚£ø‚¢Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£º‚†°‚†é‚†ª‚£ø‚£§‚£º‚°ó‚†ª‚†ª‚†¶‚£§‚†¥‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†õ‚†õ‚†Å‚†Ä‚†Ä‚£æ‚†ò‚£ø‚†õ‚°á‚¢à‚¢ö‚°á‚†Ä‚¢∏‚£Ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢∏‚£ø‚£ø‚£ø‚£ø‚°Ö‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚£ø‚£ø‚£ø‚°á‚†Ä‚¢∏‚£ø‚£ø‚¢ø‚£ß‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß‚†â‚†ã‚†ô‚†ô‚¢ª‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†Ä‚°Å‚††‚†Å‚†Ç‚°∏‚£ø‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢∏‚£ø‚£ø‚°Ω‚£ø‚£ß‚†π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚£º‚£ø‚£Ω‚£ø‚°á‚£∞‚†è‚¢∏‚£ø‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢õ‚†∑‚†à‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£ß‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢§‚£ø‚°á‚†ê‚†Ä‚°Å‚†Ñ‚¢Å‚†∞‚£ø‚†Ä‚†à‚£ø‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†ò‚¢ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£¨‚£ô‚°õ‚†ø‚£ª‚£ø‚£´‚£æ‚£ø‚£è‚£ø‚£ø‚°∂‚†ã‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Å‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£ø‚£ü‚£≥‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚††‚£¥‚£∂‚£∂‚£∂‚£æ‚†ó‚†Ä‚†Ä‚†Ä‚£¥‚£ø‚£ø‚£ø‚†Ä‚†Ç‚††‚†ê‚¢Ä‚†ê‚£ø‚†Ä‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ª‚£ø‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚£ø‚¢ø‚†è‚†Ä‚£¥‚¢ø‚°ù‚†Å‚†à‚†â‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£º‚£Ø‚£ø‚°ü‚†ª‚£∑‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†â‚†â‚†Å‚†Ä‚¢Ä‚£¥‚£æ‚£ø‚£ø‚£ø‚£ø‚°á‚†Ä‚°Å‚†ê‚°Ä‚†Ç‚£Ω‚°á‚†Ä‚¢ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ê‚£ø‚°ß‚£ø‚°ø‚¢ø‚£ª‚£Ø‚°ø‚£ø‚£Ø‚£ø‚£æ‚¢ß‚°ü‚†É‚¢†‚£º‚°ü‚°é‚†Ä‚†â‚†â‚†ô‚†õ‚†≥‚°û‚£ø‚£ø‚£ø‚°á‚†Ä‚¢Ä‚£§‚£§‚£Ä‚†Ä‚£¥‚£ø‚°ø‚†ü‚†â‚†ô‚¢¶‚£Ω‚£ø‚†ø‚¢¶‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚†õ‚¢ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚†Ä‚†Ñ‚¢Å‚††‚†ê‚°∏‚°á‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£ø‚£∑‚£â‚£ø‚£ø‚£ø‚£ø‚£ø‚£∂‚°ù‚£∑‚¢ø‚£æ‚†É‚£†‚£æ‚£ø‚¢á‚°ü‚¢Ä‚°Ä‚†ê‚†Ä‚†Ä‚†Ä‚£á‚¢∏‚£ø‚£ø‚†á‚†ê‚†ã‚†Ä‚†Ä‚¢ò‚£ø‚°ø‚†ã‚†Ä‚£†‚°Ü‚†Ä‚£æ‚°ü‚£ø‚£ø‚£æ‚£ø‚£ø‚£ø‚£∑‚£æ‚£ø‚¢ø‚°á‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†Ä‚¢à‚†Ä‚†Ñ‚†Ç‚†±‚£ø‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚£ü‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢∏‚£ø‚£ø‚¢†‚£ø‚£ø‚£ø‚¢∏‚£∑‚°∏‚¢ø‚£¶‚£Ñ‚†Ä‚£∞‚£á‚£æ‚£ø‚£ø‚†Ç‚†à‚°Ä‚†Ä‚†Ä‚£∏‚†ã‚†Ä‚£†‚£æ‚†ü‚†Ä‚¢†‚°ü‚†ª‚†ø‚†õ‚†ã‚†Ä‚†â‚†â‚†ô‚†ø‚†ø‚£¶‚°Å‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚†Ä‚¢Ç‚†Ä‚†Ç‚†å‚†ê‚£ø‚†Ä‚†ò‚£ø‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£Ω‚£ø‚£ø‚£ø‚¢π‚£ø‚£ø‚£ø‚£ø‚°ø‚£∏‚£ø‚£è‚£æ‚£ø‚£ø‚°Ø‚£æ‚°ø‚†∑‚¢Æ‚£Ω‚£ø‚£∂‚£ø‚†ø‚†ª‚°â‚†ü‚£∂‚£Ä‚†ë‚†§‚†Ä‚°ø‚†≤‚£∂‚°ø‚†ã‚†Ä‚£Ä‚†æ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°§‚†¥‚†ü‚¢ß‚°å‚†ª‚¢ø‚£ø‚£ø‚£ø‚£ø‚†É‚†Ä‚†å‚†ê‚°Ä‚†Ñ‚†ê‚£ª‚°Ä‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚††‚£ø‚£ø‚£Ø‚†ª‚£∑‚£ç‚£õ‚£õ‚¢ª‚£¥‚£ø‚†ü‚£±‚£ø‚£ø‚£ø‚£ø‚°ø‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚††‚£Ö‚£ú‚††‚†ô‚£ø‚£∂‚£Ñ‚£º‚¢ß‚°Ä‚†à‚†Ä‚£Ä‚£æ‚£ü‚£ì‚†Ç‚†Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚†∑‚£§‚£Ä‚¢®‚°ø‚¢∑‚£§‚°à‚†õ‚†õ‚†â‚†ã‚†ª‚†∂‚£∂‚£¶‚£Ñ‚†Ç‚¢π‚°á‚†Ä‚¢ø‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢ª‚£ø‚£ø‚£∑‚£Æ‚£ô‚°õ‚¢õ‚¢ª‚£ª‚£•‚£ø‚£ø‚£ø‚£ø‚†ü‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Å‚£†‚£ø‚£ø‚£ø‚£ø‚°Ñ‚†ô‚£Ñ‚†ö‚†â‚†Å‚†Ä‚†â‚†ô‚£Ü‚†à‚†ê‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢∑‚°Ñ‚†ò‚¢¶‚°â‚†â‚†≥‚¢¶‚°ô‚¢¶‚†Ä‚†Ä‚†Ä‚†â‚†∫‚°õ‚¢∂‚£ø‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢Å‚††‚¢†‚†Ä‚°Ñ‚¢†‚†Ä‚††‚¢Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°û‚†ô‚£ø‚£ø‚£ø‚£ø‚°Ñ‚†π‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ø‚°Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚°Ñ‚¢Ä‚†≥‚£§‚†Ä‚†Ä‚†Å‚†à‚†≥‚°Ä‚†Ä‚†Ä‚†Ä‚†à‚¢¢‚°ª‚°Ñ‚†∏‚£ø‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£§‚¢É‚†¶‚£°‚†í‚†§‚†ò‚††‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£§‚†ü‚†Å‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚¢π‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†©‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ª‚£Ü‚†Ä‚°à‚†≥‚£Ñ‚†Ä‚†Ä‚†Ä‚†ô‚¢¶‚°Ä‚°Ä‚†Ä‚†Ä‚†ô‚£á‚†Ä‚†à‚¢ª‚°ø‚¢ø‚£¶‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†ø‚†ø‚†∂‚†ø‚†æ‚†∑‚†∑‚†∂‚†æ‚†ü‚†õ‚†â‚†Å‚†Ä‚°ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚†ò‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ß‚°Ä‚†ê‚†ò‚¢∑‚£Ñ‚†â‚†¶‚†ø‚£á‚†Å‚†Ä‚†Ä‚†Ä‚†à‚†≥‚¢¶‚£Ä‚£ß‚°Ä‚†à‚†ª‚£∑‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°º‚¢Ö‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ê‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢Ä‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚°Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£∑‚°à‚¢Ä‚†Ç‚†ô‚¢ø‚°∂‚†∂‚†ø‚†∂‚¢¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚£ø‚£¶‚†Ä‚†ô‚£ø‚£¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£à‚†∞‚¢†‚¢Ç‚††‚¢Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£°‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†Ä‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚°Ü‚††‚†Å‚°à‚†±‚°Ü‚†Ä‚†Ä‚†≤‚£ï‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°ü‚£ø‚£∑‚°Ä‚†à‚†ª‚£∑‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢¶‚°ô‚°Ü‚¢¨‚°ë‚¢¢‚††‚£â‚£Ñ‚£†‚°¥‚†û‚†ã‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü‚†Ä‚°æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚†Ñ‚¢∞‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£ø‚°Ä‚†ê‚°Ä‚†Å‚†π‚°Ñ‚†Ä‚†Ä‚†ò‚¢ø‚°Ñ‚†Ä‚†Ä‚£†‚°æ‚¢Å‚£ø‚£ø‚£ø‚£¶‚°Ä‚†®‚†ª‚£∑‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ø‚†õ‚£ø‚£ø‚£ø‚£ø‚°ü‚°ü‚†õ‚†õ‚†õ‚†ø‚†õ‚†ø‚†õ‚†õ‚†ü‚†õ‚†â‚†Å‚††‚£Ñ‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü‚†Å‚£º‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°è‚†Ä‚£æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°á‚††‚¢Ä‚†Å‚†Ç‚¢ø‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£¶‚°æ‚¢ã‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚°Ä‚†à‚†ª‚£∑‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚†Ä‚£ò‚£ø‚£ø‚£ø‚£ø‚°±‚†°‚†å‚¢Ç‚£Ñ‚ÄÄ‚†Ä‚†Ñ‚¢Ç‚°Ä‚†Ä‚†Ä‚†Ñ‚£±‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†ã‚£†‚¢æ‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£û‚¢Å‚£∏‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†ê‚°Ä‚†à‚†Ñ‚°ò‚£á‚†Ä‚†Ä‚†Ä‚£ø‚£∑‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚°Ä‚†à‚¢ª‚£ß‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°è‚†Ä‚¢π‚£ø‚£ø‚£ø‚£ø‚£á‚†ª‚£å‚†≤‚£å‚†∑‚¢¨‚†ê‚††‚¢Ä‚†Ç‚£Ä‚£¥‚£ø‚£ø‚£ø‚£ø‚†ø‚†õ‚¢Å‚£§‚†û‚†Å‚†à‚£ø‚£Ñ‚†Ä‚†Ä‚¢Ä‚£æ‚†á‚£º‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†ê‚°Ä‚†°‚†Ä‚†Ñ‚¢ø‚†Ä‚†Ä‚†Ä‚¢π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚†à‚£ø‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°á‚†Ä‚°ø‚†à‚†ª‚£ø‚°ø‚¢ø‚¢∑‚£æ‚£ø‚£æ‚£Ω‚£¶‚£≠‚£∂‚†ü‚†õ‚†õ‚†õ‚†õ‚¢â‚£â‚£†‚°¥‚†û‚†ã‚†Ä‚£†‚£∂‚°Ä‚†ò‚¢ø‚£¶‚£∂‚°ø‚†ã‚†ö‚†õ‚†ì‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢®‚°ó‚††‚†ê‚†Ä‚†°‚†Ä‚¢º‚°Ü‚†Ä‚†Ä‚¢π‚£ø‚°è‚¢π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚¢∞‚£ø‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚£ø‚†Ä‚¢∞‚°á‚††‚¢Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£æ‚†õ‚†õ‚†â‚†Å‚£Ä‚£§‚£∂‚†ø‚†õ‚†ª‚£ø‚°Ä‚†∏‚£ø‚°ø‚°ñ‚†í‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚¢Ä‚†Ç‚¢Å‚†Ç‚¢Å‚†Ä‚£ß‚†Ä‚†Ä‚†∏‚£ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†á‚†Ä‚£º‚°è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∏‚°è‚†Ä‚£∏‚†Ä‚††‚†Ä‚†å‚†Ä‚††‚†à‚¢Ä‚†ê‚†Ä‚†Ç‚†Ä‚†à‚†â‚¢â‚£ø‚£ø‚£ø‚†Ä‚¢∞‚£æ‚†ø‚†õ‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚¢ø‚£ß‚†Ä‚¢∏‚£∑‚£∑‚†Ä‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£á‚†Ä‚°ê‚††‚†ê‚†Ä‚¢Ç‚¢ª‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚†ü‚£ª‚£ø‚£ø‚£ø‚£ª‚°ü‚£ø‚£ø‚°ü‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°á‚†Ä‚£ø‚†Ä‚°Ä‚¢Å‚†Ç‚†à‚†Ä‚†Ñ‚†Ç‚†Ä‚†å‚†Ä‚†Å‚†Ä‚†Ä‚£æ‚£ø‚£ø‚£ø‚†Ä‚†à‚£ø‚†Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†©‚£ø‚£Ü‚†Ä‚¢ª‚£ø‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚†Ä‚††‚†ê‚°Ä‚†°‚¢Ä‚¢∏‚°Ü‚†Ä‚¢∏‚£ø‚£ø‚£•‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†à‚£ø‚†Ä‚¢†‚£ø‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚†Ä‚¢∞‚°á‚†Ä‚†Ñ‚°Ä‚†Ç‚¢Å‚†Ä‚†Ç‚¢Ä‚†ê‚†Ä‚£à‚£§‚£Ñ‚£æ‚£ø‚£ø‚£ø‚£ø‚°Ñ‚†Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚£ø‚°Ñ‚†à‚¢ø‚£ß‚†§‚†Ä‚†Ä‚†Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚†Ä‚†°‚†ê‚¢Ä‚†ê‚°Ä‚†à‚£∑‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚°ø‚†Å‚£∞‚†á‚†Ä‚£æ‚°è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∏‚°ü‚†Ä‚¢∏‚†É‚¢Ä‚†Ç‚††‚†ê‚†Ä‚°Ä‚†å‚†Ä‚†Ä‚†Ñ‚£æ‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚£ø‚°á‚†Ä‚¢ª‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£∑‚°Ä‚†ò‚£ø‚£Ü‚†Ä‚¢Ä‚††‚†ê‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°Ö‚†Ç‚¢à‚††‚†Ä‚†Ñ‚°Å‚†∏‚°Ü‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢±‚£á‚£Ä‚°ü‚†Ä‚£º‚°ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°á‚†Ä‚°ø‚†Ä‚††‚†Ä‚°Å‚¢Ä‚†Ç‚†Ä‚††‚†ê‚†à‚†Ä‚£ø‚£ø‚£ø‚£Ø‚£ø‚£ø‚£ø‚£ø‚°á‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ø‚£ß‚†Ä‚¢π‚£ø‚°Ñ‚†Ä‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚°á‚†Ä‚¢Ç‚††‚†à‚°Ä‚†Ñ‚†Å‚¢ø‚£ª‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢†‚£ü‚£º‚°ø‚†Å‚¢∞‚£ø‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£ø‚†Ä‚¢∞‚°á‚†Ä‚°Å‚††‚†ê‚†Ä‚†Ä‚†Ä‚†Ç‚†Ä‚†Ñ‚£†‚£ø‚£ø‚£ø‚£ü‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚°Ñ‚†Ä‚¢ª‚£ß‚†Ä‚†Ä‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ª‚£á‚†à‚°Ä‚†Ñ‚†Ç‚°Ä‚†Ç‚¢Å‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£•‚°ü‚°¥‚£º‚†É‚¢Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚†Ä‚¢∏‚°á‚†Ä‚°Ñ‚†ê‚¢†‚†Ä‚†Å‚†Ä‚°Ñ‚£¥‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ª‚£ø‚£ø‚£ø‚£ø‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚£ø‚°Ñ‚†à‚£ø‚°Ü‚†Ä‚¢†‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚£ø‚†Ä‚°Ñ‚†Ç‚†Å‚¢†‚†à‚¢†‚†Ä‚¢π‚£ø‚£ø‚£ø‚¢ª‚£ø‚£æ‚¢≥‚¢≥‚°è‚†Ä‚£º‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚£æ‚°á‚†Ä‚£æ‚£Ñ‚£Ä‚£Ñ‚£ê‚£Ä‚£Ä‚£Ä‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚¢∏‚£ø‚£†‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚£ß‚†Ä‚£π‚£ø‚£§‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£∏‚£ø‚£Ä‚£†‚£î‚£à‚£§‚£ê‚£Ä‚£à‚£Ä‚£à‚£π‚£ø‚£ø‚£æ‚£∑‚£è‚£æ‚†Å‚£†‚£ø‚°É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Ä‚†à‚†Å‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†à‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

            88     888888 888888 .dP"Y8     8b    d8 888888 88     888888     88    dP""b8   888888 
            88     88__     88   `Ybo."     88b  d88 88__   88       88       88   dP   `"   88__   
            88  .o 88""     88   A `Y8b     88Y\/P88 88""   88  .o   88       88   Yb        88""   
            88ood8 888888   88   8bodP'     88 Y7 88 888888 88ood8   88       88 0  YioodP 0 888888 0                                                   ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
        """)

        stream = self.capture_stream_audio()
        if not stream:
            return

        chunk_size = 1024 * 2
        samples_per_chunk = chunk_size // 2
        chunks_per_second = self.sample_rate / samples_per_chunk
        silence_chunks_threshold = int(self.silence_duration * chunks_per_second)

        recording_transmission = False
        current_transmission = []
        silence_count = 0

        start_time = time.time()
        info("Listening for transmissions...", emoji="üëÇ")

        try:
            # The main loop now simply runs until the parent thread stops it.
            while True:
                # If a max_duration is set, check if we've exceeded it.
                if max_duration is not None and (time.time() - start_time) > max_duration:
                    info("Maximum recording duration reached.")
                    break

                chunk = stream.read(chunk_size)
                if not chunk:
                    info("Stream ended.")
                    break

                has_voice = self.detect_voice_activity(chunk)

                if has_voice:
                    if not recording_transmission:
                        info("Transmission detected - recording...", emoji="üéôÔ∏è")
                        recording_transmission = True
                        current_transmission = []

                    current_transmission.append(chunk)
                    silence_count = 0

                elif recording_transmission:
                    current_transmission.append(chunk)
                    silence_count += 1

                    if silence_count >= silence_chunks_threshold:
                        info("Transmission ended - saving...", emoji="üìÅ")
                        self.save_audio_segment(current_transmission, frequency)
                        recording_transmission = False
                        current_transmission = []
                        silence_count = 0
                        info("Listening for transmissions...", emoji="üëÇ")

        except Exception as e:
            error(f"An error occurred during recording: {e}")
        finally:
            if recording_transmission and current_transmission:
                info("Saving final transmission...", emoji="üìÅ")
                self.save_audio_segment(current_transmission, frequency)

            if self.ffmpeg_process:
                self.ffmpeg_process.terminate()
                try:
                    self.ffmpeg_process.wait(timeout=2)
                except subprocess.TimeoutExpired:
                    self.ffmpeg_process.kill()
            success("Recording session completed.", emoji="üé¨")


class SystemAudioRecorder:
    def __init__(self, vad_threshold=0.01, silence_duration=2.0):
        self.vad_threshold = vad_threshold
        self.silence_duration = silence_duration
        if not os.path.exists(AUDIO_DIR):
            os.makedirs(AUDIO_DIR)

    def record_system_audio_with_vad(self, frequency=None, device_index=None):
        """Record from system audio with VAD"""
        p = pyaudio.PyAudio()
        stream = None
        try:
            stream = p.open(
                format=pyaudio.paInt16,
                channels=CHANNELS,
                rate=SAMPLE_RATE,
                input=True,
                input_device_index=device_index,
                frames_per_buffer=1024
            )
        except Exception as e:
            error(f"Failed to open audio stream: {e}")
            p.terminate()
            return

        info("Recording system audio with VAD...", emoji="üéß")
        # Identical logic to LiveATC recorder can be applied here if needed
        # For now, keeping it simple
        # ...

    def save_audio_segment(self, audio_data, frequency=None):
        """Save recorded audio segment"""
        if not audio_data:
            return None
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S_%f")[:-3]
        freq_str = f"_{frequency.replace('.', 'p')}" if frequency else ""
        filename = os.path.join(AUDIO_DIR, f"transmission_{timestamp}{freq_str}.wav")
        try:
            with wave.open(filename, 'wb') as wf:
                wf.setnchannels(CHANNELS)
                wf.setsampwidth(pyaudio.PyAudio().get_sample_size(pyaudio.paInt16))
                wf.setframerate(SAMPLE_RATE)
                wf.writeframes(b''.join(audio_data))
            success(f"Saved: {os.path.basename(filename)}", emoji="üíæ")
            return filename
        except Exception as e:
            error(f"Error saving audio to {filename}: {e}")
            return None
